{% extends "base.html" %}
{% block title %}Edit User{% endblock %}
{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1><i class="fas fa-user-edit"></i> Edit User: {{ edit_user.username }}</h1>
        {% if edit_user.user_id == 'admin' %}
        <div class="alert alert-warning">Admin user cannot be edited</div>
        {% endif %}
    </div>
</div>

{% if edit_user.user_id != 'admin' %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <form id="editUserForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">User ID</label>
                            <input type="text" class="form-control" value="{{ edit_user.user_id }}" disabled>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" value="{{ edit_user.username }}" disabled>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" name="full_name" value="{{ edit_user.full_name }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" value="{{ edit_user.email }}">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Password (leave blank to keep current)</label>
                            <input type="password" class="form-control" name="password">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Role</label>
                            <select class="form-control" name="role">
                                <option value="user" {% if edit_user.role == 'user' %}selected{% endif %}>User</option>
                                <option value="admin" {% if edit_user.role == 'admin' %}selected{% endif %}>Admin</option>
                            </select>
                        </div>
                    </div>
                    
                    <h5 class="mt-4">Permissions</h5>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Approved Tools</label>
                            <select class="form-control" id="toolsSelect" multiple size="10">
                                <option value="*" {% if '*' in edit_user.approved_tools %}selected{% endif %}>* (All Tools)</option>
                                {% for tool in all_tools %}
                                <option value="{{ tool.tool_name }}" {% if tool.tool_name in edit_user.approved_tools %}selected{% endif %}>
                                    {{ tool.tool_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Approved Agents</label>
                            <select class="form-control" id="agentsSelect" multiple size="10">
                                <option value="*" {% if '*' in edit_user.approved_agents %}selected{% endif %}>* (All Agents)</option>
                                {% for agent in all_agents %}
                                <option value="{{ agent.agent_id }}" {% if agent.agent_id in edit_user.approved_agents %}selected{% endif %}>
                                    {{ agent.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Approved DAGs</label>
                            <select class="form-control" id="dagsSelect" multiple size="10">
                                <option value="*" {% if '*' in edit_user.approved_dags %}selected{% endif %}>* (All DAGs)</option>
                                {% for dag in all_dags %}
                                <option value="{{ dag.dag_id }}" {% if dag.dag_id in edit_user.approved_dags %}selected{% endif %}>
                                    {{ dag.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                        <a href="{{ url_for('users') }}" class="btn btn-secondary">Cancel</a>
                        <button type="button" class="btn btn-danger float-end" onclick="deleteUser()">
                            <i class="fas fa-trash"></i> Delete User
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('editUserForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const userData = {
        full_name: formData.get('full_name'),
        email: formData.get('email'),
        role: formData.get('role'),
        approved_tools: Array.from(document.getElementById('toolsSelect').selectedOptions).map(o => o.value),
        approved_agents: Array.from(document.getElementById('agentsSelect').selectedOptions).map(o => o.value),
        approved_dags: Array.from(document.getElementById('dagsSelect').selectedOptions).map(o => o.value)
    };
    
    const password = formData.get('password');
    if (password) {
        userData.password = password;
    }
    
    $.ajax({
        url: '/api/edit_user/{{ edit_user.user_id }}',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(userData),
        success: function(response) {
            alert('User updated successfully!');
            window.location.href = '{{ url_for("users") }}';
        },
        error: function(xhr) {
            alert('Error: ' + (xhr.responseJSON?.error || 'Failed to update user'));
        }
    });
});

function deleteUser() {
    if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
        $.ajax({
            url: '/api/delete_user/{{ edit_user.user_id }}',
            method: 'POST',
            success: function() {
                alert('User deleted successfully');
                window.location.href = '{{ url_for("users") }}';
            },
            error: function(xhr) {
                alert('Error: ' + (xhr.responseJSON?.error || 'Failed to delete user'));
            }
        });
    }
}
</script>
{% endif %}
{% endblock %}
