{% extends "base.html" %}

{% block title %}Document Sessions{% endblock %}

{% block extra_head %}
<style>
    .session-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
    }

    .session-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }

    .file-badge {
        display: inline-block;
        padding: 4px 8px;
        margin: 2px;
        background-color: #e9ecef;
        border-radius: 4px;
        font-size: 0.85rem;
    }

    .file-badge i {
        margin-right: 4px;
    }

    .outbox-item {
        padding: 8px;
        background-color: #f8f9fa;
        border-left: 3px solid #28a745;
        margin-bottom: 8px;
        border-radius: 4px;
    }

    .session-name-link {
        font-size: 1.1rem;
        font-weight: 600;
        color: #0d6efd;
        text-decoration: none;
    }

    .session-name-link:hover {
        text-decoration: underline;
        color: #0a58ca;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.5;
    }

    .file-scroll {
        max-height: 200px;
        overflow-y: auto;
    }

    .table-responsive {
        max-height: calc(100vh - 300px);
        overflow-y: auto;
    }

    .session-actions {
        white-space: nowrap;
    }

    .btn-delete-session {
        transition: all 0.2s ease;
    }

    .btn-delete-session:hover {
        transform: scale(1.05);
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1><i class="fas fa-folder-open"></i> Document Sessions</h1>
        <p class="text-muted">View and manage your document generation sessions</p>
    </div>
    <div class="col-auto">
        <button class="btn btn-primary" onclick="createNewSession()">
            <i class="fas fa-plus"></i> New Session
        </button>
        <button class="btn btn-outline-secondary" onclick="refreshSessions()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>
</div>

<!-- Loading State -->
<div id="loadingState" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3 text-muted">Loading sessions...</p>
</div>

<!-- Empty State -->
<div id="emptyState" class="empty-state" style="display: none;">
    <i class="fas fa-folder-open"></i>
    <h3>No Document Sessions Yet</h3>
    <p>Create your first document generation session to get started.</p>
    <button class="btn btn-primary btn-lg" onclick="createNewSession()">
        <i class="fas fa-plus"></i> Create First Session
    </button>
</div>

<!-- Sessions Table -->
<div id="sessionsContainer" style="display: none;">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-list"></i> All Sessions (<span id="sessionCount">0</span>)</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 20%;">Session Name</th>
                            <th style="width: 12%;">Created</th>
                            <th style="width: 15%;">Inbox Files</th>
                            <th style="width: 35%;">Outbox Files</th>
                            <th style="width: 10%;" class="text-center">Status</th>
                            <th style="width: 8%;" class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="sessionsTableBody">
                        <!-- Sessions will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the session: <strong id="deleteSessionName"></strong>?</p>
                <p class="text-muted mb-0">This action cannot be undone. All files in the inbox and outbox will be permanently deleted.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                    <i class="fas fa-trash"></i> Delete Session
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let sessions = [];
    let sessionToDelete = null;
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));

    // Load sessions on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadSessions();
    });

    function loadSessions() {
        // Show loading state
        document.getElementById('loadingState').style.display = 'block';
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('sessionsContainer').style.display = 'none';

        $.ajax({
            url: '{{ url_for("api_list_document_sessions_detailed") }}',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    sessions = response.sessions;
                    displaySessions();
                } else {
                    showAlert('danger', response.error || 'Failed to load sessions');
                    showEmptyState();
                }
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || 'Failed to load sessions';
                showAlert('danger', error);
                showEmptyState();
            }
        });
    }

    function displaySessions() {
        document.getElementById('loadingState').style.display = 'none';

        if (sessions.length === 0) {
            showEmptyState();
            return;
        }

        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('sessionsContainer').style.display = 'block';
        document.getElementById('sessionCount').textContent = sessions.length;

        const tbody = document.getElementById('sessionsTableBody');
        tbody.innerHTML = '';

        sessions.forEach(function(session) {
            const row = createSessionRow(session);
            tbody.appendChild(row);
        });
    }

    function createSessionRow(session) {
        const tr = document.createElement('tr');

        // Session Name (clickable link)
        const tdName = document.createElement('td');
        const sessionLink = document.createElement('a');
        sessionLink.href = `{{ url_for('document_generation') }}?session=${encodeURIComponent(session.name)}`;
        sessionLink.className = 'session-name-link';
        sessionLink.innerHTML = `<i class="fas fa-folder"></i> ${escapeHtml(session.name)}`;
        tdName.appendChild(sessionLink);
        tr.appendChild(tdName);

        // Created Date
        const tdCreated = document.createElement('td');
        tdCreated.innerHTML = `<small class="text-muted">${formatDate(session.created_time)}</small>`;
        tr.appendChild(tdCreated);

        // Inbox Files
        const tdInbox = document.createElement('td');
        if (session.inbox_files && session.inbox_files.length > 0) {
            const inboxDiv = document.createElement('div');
            inboxDiv.className = 'file-scroll';
            session.inbox_files.forEach(function(file) {
                const badge = document.createElement('span');
                badge.className = 'file-badge';
                badge.innerHTML = `<i class="fas fa-file"></i> ${escapeHtml(file.name)}`;
                badge.title = `Size: ${formatFileSize(file.size)}`;
                inboxDiv.appendChild(badge);
            });
            tdInbox.appendChild(inboxDiv);
        } else {
            tdInbox.innerHTML = '<span class="text-muted"><i class="fas fa-inbox"></i> Empty</span>';
        }
        tr.appendChild(tdInbox);

        // Outbox Files
        const tdOutbox = document.createElement('td');
        if (session.outbox_files && session.outbox_files.length > 0) {
            const outboxDiv = document.createElement('div');
            outboxDiv.className = 'file-scroll';
            session.outbox_files.forEach(function(file) {
                const outboxItem = document.createElement('div');
                outboxItem.className = 'outbox-item';
                outboxItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-file-alt"></i> <strong>${escapeHtml(file.name)}</strong></span>
                        <small class="text-muted">${formatDate(file.modified_time)}</small>
                    </div>
                    <small class="text-muted">${formatFileSize(file.size)}</small>
                `;
                outboxDiv.appendChild(outboxItem);
            });
            tdOutbox.appendChild(outboxDiv);
        } else {
            tdOutbox.innerHTML = '<span class="text-muted"><i class="fas fa-box-open"></i> No outputs yet</span>';
        }
        tr.appendChild(tdOutbox);

        // Status
        const tdStatus = document.createElement('td');
        tdStatus.className = 'text-center';
        const hasOutput = session.outbox_files && session.outbox_files.length > 0;
        const statusBadge = hasOutput
            ? '<span class="badge bg-success"><i class="fas fa-check-circle"></i> Completed</span>'
            : '<span class="badge bg-warning"><i class="fas fa-clock"></i> Pending</span>';
        tdStatus.innerHTML = statusBadge;
        tr.appendChild(tdStatus);

        // Actions
        const tdActions = document.createElement('td');
        tdActions.className = 'text-center session-actions';
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'btn-group';

        // Open button
        const openBtn = document.createElement('a');
        openBtn.href = `{{ url_for('document_generation') }}?session=${encodeURIComponent(session.name)}`;
        openBtn.className = 'btn btn-sm btn-outline-primary';
        openBtn.title = 'Open Session';
        openBtn.innerHTML = '<i class="fas fa-folder-open"></i>';
        actionsDiv.appendChild(openBtn);

        // Delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-sm btn-outline-danger btn-delete-session';
        deleteBtn.title = 'Delete Session';
        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
        deleteBtn.onclick = function() {
            showDeleteModal(session.name);
        };
        actionsDiv.appendChild(deleteBtn);

        tdActions.appendChild(actionsDiv);
        tr.appendChild(tdActions);

        return tr;
    }

    function showEmptyState() {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('sessionsContainer').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
    }

    function showDeleteModal(sessionName) {
        sessionToDelete = sessionName;
        document.getElementById('deleteSessionName').textContent = sessionName;
        deleteModal.show();
    }

    function confirmDelete() {
        if (!sessionToDelete) return;

        const sessionName = sessionToDelete;
        sessionToDelete = null;
        deleteModal.hide();

        // Show loading state
        showAlert('info', 'Deleting session...');

        $.ajax({
            url: '{{ url_for("delete_document_session") }}',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                session_name: sessionName
            }),
            success: function(response) {
                if (response.success) {
                    showAlert('success', response.message);
                    // Reload sessions
                    loadSessions();
                } else {
                    showAlert('danger', response.error);
                }
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || 'Failed to delete session';
                showAlert('danger', error);
            }
        });
    }

    function refreshSessions() {
        loadSessions();
        showAlert('info', 'Refreshing sessions...');
    }

    function createNewSession() {
        // Redirect to document generation page
        window.location.href = '{{ url_for("document_generation") }}';
    }

    function formatDate(timestamp) {
        if (!timestamp) return 'N/A';
        const date = new Date(timestamp * 1000);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
        if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
        if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;

        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showAlert(type, message) {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;

        const main = document.querySelector('main');
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = alertHtml;
        main.insertBefore(tempDiv.firstElementChild, main.firstChild);

        // Auto-dismiss after 5 seconds (except for errors)
        if (type !== 'danger') {
            setTimeout(function() {
                const alert = main.querySelector('.alert');
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        }
    }
</script>
{% endblock %}