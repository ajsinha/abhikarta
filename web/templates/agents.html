{% extends "base.html" %}
{% block title %}Agents{% endblock %}
{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1><i class="fas fa-robot"></i> Agents</h1>
    </div>
    <div class="col text-end">
        {% if user.is_admin() %}
        <a href="{{ url_for('create_agent_page') }}" class="btn btn-success">
            <i class="fas fa-plus-circle"></i> Create New Agent
        </a>
        {% endif %}
    </div>
</div>

<div class="card mt-4">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Agent ID</th>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Capabilities</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for agent in agents %}
                    <tr>
                        <td><code>{{ agent.agent_id }}</code></td>
                        <td>{{ agent.name }}</td>
                        <td>{{ agent.description }}</td>
                        <td>
                            {% if agent.capabilities %}
                                {% for cap in agent.capabilities %}
                                    <span class="badge bg-secondary">{{ cap }}</span>
                                {% endfor %}
                            {% else %}
                                <span class="text-muted">None</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if agent.enabled %}
                                <span class="badge bg-success">Enabled</span>
                            {% else %}
                                <span class="badge bg-secondary">Disabled</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('execute_agent_form', agent_id=agent.agent_id) }}"
                               class="btn btn-sm btn-primary"
                               {% if not agent.enabled %}disabled{% endif %}>
                                <i class="fas fa-play"></i> Execute
                            </a>
                            {% if user.is_admin() %}
                                {% if agent.enabled %}
                                    <button class="btn btn-sm btn-warning"
                                            onclick="toggleAgent('{{ agent.agent_id }}', 'disable')">
                                        <i class="fas fa-power-off"></i> Disable
                                    </button>
                                {% else %}
                                    <button class="btn btn-sm btn-success"
                                            onclick="toggleAgent('{{ agent.agent_id }}', 'enable')">
                                        <i class="fas fa-check"></i> Enable
                                    </button>
                                {% endif %}
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Load jQuery before using it -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
// Debug: Log agent count on page load
$(document).ready(function() {
    const agentCount = $('tbody tr').length;
    console.log('Agents page loaded. Number of agents displayed:', agentCount);
    console.log('Agent data from server:', {{ agents | tojson }});
});

function toggleAgent(agentId, action) {
    if (!confirm('Are you sure you want to ' + action + ' this agent?')) {
        return;
    }

    $.ajax({
        url: '{{ url_for("api_toggle_agent") }}',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            agent_id: agentId,
            action: action
        }),
        success: function(response) {
            if (response.success) {
                alert('Success: ' + response.message);
                location.reload();
            } else {
                alert('Error: ' + (response.error || 'Failed to ' + action + ' agent'));
            }
        },
        error: function(xhr, status, error) {
            console.error('Toggle agent error:', xhr.responseText);
            let errorMsg = 'Error ' + action + 'ing agent';
            try {
                const response = JSON.parse(xhr.responseText);
                if (response.error) {
                    errorMsg = response.error;
                }
            } catch (e) {
                console.error('Could not parse error response:', e);
            }
            alert(errorMsg);
        }
    });
}
</script>
{% endblock %}